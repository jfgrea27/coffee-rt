# v3: Kafka + Apache Flink Stream Processing
# Usage: helm install coffee-rt ./helm/coffee-rt -f ./helm/coffee-rt/values.v3.yaml
#
# Architecture: API → Kafka → Flink → PostgreSQL + Redis → Dashboard

# Global configuration
global:
  imageRegistry: ""
  imagePullSecrets: []

# API Service - writes to Kafka
api:
  enabled: true
  replicaCount: 2
  image:
    repository: coffee-rt/cafe-order-api
    tag: latest
    pullPolicy: Never
  service:
    type: ClusterIP
    port: 8005
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi
  dashboardUpdateInterval: 10
  # Enable Kafka for v3
  kafka:
    enabled: true
    bootstrapServers: coffee-rt-kafka:9092

# Disable v1 aggregator (Flink handles processing)
aggregator:
  enabled: false

# Disable v2 stream-worker (Flink handles processing)
stream-worker:
  enabled: false

# Flink - stream processing
flink:
  enabled: true
  jobmanager:
    replicaCount: 1
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 100m
        memory: 512Mi
  taskmanager:
    replicaCount: 1
    numberOfTaskSlots: 2
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 100m
        memory: 512Mi
  job:
    image:
      repository: coffee-rt/flink-job
      tag: latest
      pullPolicy: Never
    kafka:
      topic: orders
      consumerGroup: flink-processors
    windowSeconds: 1

# Kafka - message broker
kafka:
  enabled: true
  replicaCount: 1
  image:
    repository: apache/kafka
    tag: "4.1.1"
    pullPolicy: IfNotPresent
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 512Mi
  persistence:
    enabled: true
    size: 1Gi
  topics:
    - name: orders
      partitions: 3
      replicationFactor: 1

# Frontend
frontend:
  enabled: true
  image:
    repository: coffee-rt/cafe-dashboard
    tag: latest
    pullPolicy: Never
  service:
    type: ClusterIP
    port: 80
  resources:
    limits:
      cpu: 200m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Database configuration
database:
  password: coffee-rt_password

# PostgreSQL subchart configuration (Bitnami)
postgresql:
  enabled: true
  image:
    tag: latest
    pullPolicy: IfNotPresent
  auth:
    username: coffee-rt
    password: coffee-rt_password
    database: coffee-rt
  primary:
    initdb:
      scripts:
        init-schema.sql: |
          CREATE SCHEMA IF NOT EXISTS coffee_rt;

          DO $$ BEGIN
              CREATE TYPE coffee_rt.drink AS ENUM ('cappuccino', 'americano', 'latte');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;

          DO $$ BEGIN
              CREATE TYPE coffee_rt.store AS ENUM ('uptown', 'downtown', 'central', 'southend');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;

          CREATE TABLE IF NOT EXISTS coffee_rt.orders (
              id SERIAL PRIMARY KEY,
              message_id VARCHAR(36) UNIQUE,
              drink coffee_rt.drink NOT NULL,
              store coffee_rt.store NOT NULL,
              price NUMERIC(10, 2) NOT NULL,
              timestamp TIMESTAMP NOT NULL DEFAULT NOW()
          );
    persistence:
      enabled: true
      size: 1Gi

# Redis subchart configuration (Bitnami)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  image:
    tag: latest
    pullPolicy: IfNotPresent
  master:
    persistence:
      enabled: true
      size: 1Gi

# Observability - enabled by default
prometheus:
  enabled: true
  server:
    persistentVolume:
      enabled: false
    service:
      type: ClusterIP

loki:
  enabled: false

promtail:
  enabled: false

grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin
  service:
    type: ClusterIP
    port: 80
  persistence:
    enabled: false
