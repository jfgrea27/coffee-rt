# Global configuration
global:
  imageRegistry: ""
  imagePullSecrets: []

# API Service subchart
api:
  enabled: true

# Aggregator CronJob subchart
aggregator:
  enabled: true

# Frontend subchart
frontend:
  enabled: true

# Database configuration (shared across subcharts)
database:
  host: ""  # Leave empty to use subchart default
  port: 5432
  name: coffee-rt
  user: coffee-rt
  schema: coffee_rt
  password: ""  # Set via existingSecret or values.dev.yaml

# Redis configuration (shared across subcharts)
redisConfig:
  host: ""  # Leave empty to use subchart default
  port: 6379

# PostgreSQL subchart configuration
postgresql:
  enabled: false

# Redis subchart configuration
redis:
  enabled: false

# Prometheus configuration
prometheus:
  enabled: false
  server:
    persistentVolume:
      enabled: false
    service:
      type: ClusterIP
  alertmanager:
    enabled: false
  kube-state-metrics:
    enabled: true
  prometheus-node-exporter:
    enabled: true
  prometheus-pushgateway:
    enabled: false

# Loki configuration (log aggregation)
loki:
  enabled: false
  deploymentMode: SingleBinary
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
  singleBinary:
    replicas: 1
    persistence:
      enabled: false
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0
  gateway:
    enabled: false
  # Disable test pods that can cause issues
  test:
    enabled: false
  lokiCanary:
    enabled: false

# Promtail configuration (log collector)
promtail:
  enabled: false
  config:
    clients:
      - url: http://{{ .Release.Name }}-loki:3100/loki/api/v1/push
    snippets:
      pipelineStages:
        - cri: {}
        - multiline:
            firstline: '^\d{4}-\d{2}-\d{2}'
      scrapeConfigs: |
        - job_name: kubernetes-pods
          pipeline_stages:
            {{- toYaml .Values.config.snippets.pipelineStages | nindent 4 }}
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_controller_name
              regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
              action: replace
              target_label: __tmp_controller_name
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_name
                - __meta_kubernetes_pod_label_app
                - __tmp_controller_name
                - __meta_kubernetes_pod_name
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: app
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_instance
                - __meta_kubernetes_pod_label_instance
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: instance
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_component
                - __meta_kubernetes_pod_label_component
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: component
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_node_name
              target_label: node_name
            - action: replace
              source_labels:
                - __meta_kubernetes_namespace
              target_label: namespace
            - action: replace
              replacement: $1
              separator: /
              source_labels:
                - namespace
                - app
              target_label: job
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_name
              target_label: pod
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_container_name
              target_label: container
            - action: replace
              replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__
            - action: replace
              regex: true/(.*)
              replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash
                - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash
                - __meta_kubernetes_pod_container_name
              target_label: __path__

# Grafana configuration
grafana:
  enabled: false
  adminUser: admin
  adminPassword: admin
  service:
    type: ClusterIP
    port: 80
  persistence:
    enabled: false
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://{{ .Release.Name }}-prometheus-server
          access: proxy
          isDefault: true
        - name: Loki
          type: loki
          url: http://{{ .Release.Name }}-loki:3100
          access: proxy
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  dashboards:
    default:
      coffee-rt-overview:
        json: |
          {
            "title": "Coffee RT Overview",
            "uid": "coffee-rt-overview",
            "schemaVersion": 39,
            "panels": [
              {
                "id": 1,
                "title": "HTTP Request Rate",
                "type": "timeseries",
                "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "sum(rate(http_requests_total[5m])) by (endpoint, method)",
                    "legendFormat": "{{method}} {{endpoint}}",
                    "refId": "A"
                  }
                ],
                "fieldConfig": {"defaults": {"unit": "reqps"}}
              },
              {
                "id": 2,
                "title": "HTTP Response Time (p95)",
                "type": "timeseries",
                "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint))",
                    "legendFormat": "{{endpoint}}",
                    "refId": "A"
                  }
                ],
                "fieldConfig": {"defaults": {"unit": "s"}}
              },
              {
                "id": 3,
                "title": "Orders per Minute",
                "type": "timeseries",
                "gridPos": {"h": 6, "w": 12, "x": 0, "y": 8},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "sum(rate(orders_created_total[5m])) by (drink) * 60",
                    "legendFormat": "{{drink}}",
                    "refId": "A"
                  }
                ],
                "fieldConfig": {"defaults": {"unit": "short"}}
              },
              {
                "id": 4,
                "title": "Revenue per Minute ($)",
                "type": "timeseries",
                "gridPos": {"h": 6, "w": 12, "x": 12, "y": 8},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "sum(rate(order_value_total[5m])) by (store) * 60",
                    "legendFormat": "{{store}}",
                    "refId": "A"
                  }
                ],
                "fieldConfig": {"defaults": {"unit": "currencyUSD"}}
              },
              {
                "id": 5,
                "title": "Aggregator Active Jobs",
                "type": "stat",
                "gridPos": {"h": 4, "w": 6, "x": 0, "y": 14},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "sum(kube_cronjob_status_active{cronjob=~\".*aggregator.*\"}) or vector(0)",
                    "legendFormat": "Active",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 6,
                "title": "Aggregator Jobs Succeeded",
                "type": "stat",
                "gridPos": {"h": 4, "w": 6, "x": 6, "y": 14},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "sum(kube_job_status_succeeded{job_name=~\".*aggregator.*\"}) or vector(0)",
                    "legendFormat": "Succeeded",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 7,
                "title": "Aggregator Jobs Failed",
                "type": "stat",
                "gridPos": {"h": 4, "w": 6, "x": 12, "y": 14},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "sum(kube_job_status_failed{job_name=~\".*aggregator.*\"}) or vector(0)",
                    "legendFormat": "Failed",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 8,
                "title": "Time Since Last Schedule",
                "type": "stat",
                "gridPos": {"h": 4, "w": 6, "x": 18, "y": 14},
                "datasource": "Prometheus",
                "targets": [
                  {
                    "expr": "time() - max(kube_cronjob_status_last_schedule_time{cronjob=~\".*aggregator.*\"})",
                    "legendFormat": "Seconds Ago",
                    "refId": "A"
                  }
                ],
                "fieldConfig": {"defaults": {"unit": "s"}}
              },
              {
                "id": 9,
                "title": "API Logs",
                "type": "logs",
                "gridPos": {"h": 8, "w": 12, "x": 0, "y": 18},
                "datasource": "Loki",
                "targets": [
                  {
                    "expr": "{namespace=\"coffee-ns\", app=\"api\"}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 10,
                "title": "Frontend Logs",
                "type": "logs",
                "gridPos": {"h": 8, "w": 12, "x": 12, "y": 18},
                "datasource": "Loki",
                "targets": [
                  {
                    "expr": "{namespace=\"coffee-ns\", app=\"frontend\"}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 11,
                "title": "Aggregator Logs",
                "type": "logs",
                "gridPos": {"h": 8, "w": 24, "x": 0, "y": 26},
                "datasource": "Loki",
                "targets": [
                  {
                    "expr": "{namespace=\"coffee-ns\", app=\"aggregator\"}",
                    "refId": "A"
                  }
                ]
              }
            ]
          }
