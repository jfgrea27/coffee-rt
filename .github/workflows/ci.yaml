name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Restrict default permissions
permissions:
  contents: read

jobs:
  # Detect which services have changes by parsing pyproject.toml dependencies
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      helm: ${{ steps.detect.outputs.helm }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for build-all flag in commit message
        id: check_build_all
        run: |
          COMMIT_MSG=$(git log -1 --format=%B)
          if echo "$COMMIT_MSG" | grep -q '\[ci-build-push-all\]'; then
            echo "build_all=true" >> $GITHUB_OUTPUT
          else
            echo "build_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changes
        id: detect
        env:
          BUILD_ALL: ${{ steps.check_build_all.outputs.build_all }}
        run: |
          (git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null \
            || git diff --name-only HEAD~1 HEAD) \
            | python3 .github/scripts/detect_changes.py

  lint-backend:
    name: Lint Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Ruff linter
        run: uv run ruff check .

      - name: Run Ruff formatter check
        run: uv run ruff format --check .

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Type check
        run: |
          cd frontend
          npm run build -- --noEmit || npx tsc --noEmit

  lint-flink:
    name: Lint Flink
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Run Checkstyle
        run: |
          cd flink/coffee-rt-flink
          mvn checkstyle:check -B

  unit-tests-backend:
    name: Unit Tests (Backend)
    runs-on: ubuntu-latest
    needs: lint-backend
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv sync --dev
          uv pip install pytest-cov

      - name: Run shared tests with coverage
        run: |
          cd backend/shared
          uv run pytest tests/ -v --tb=short \
            --cov=src/shared \
            --cov-report=xml:../../coverage-shared.xml \
            --cov-report=term-missing

      - name: Run cafe_order_api tests with coverage
        run: |
          cd backend/cafe_order_api
          uv run pytest tests/ -v --tb=short \
            --cov=src/cafe_order_api \
            --cov-report=xml:../../coverage-api.xml \
            --cov-report=term-missing \
            --cov-fail-under=70

      - name: Run cafe_order_aggregator tests with coverage
        run: |
          cd backend/cafe_order_aggregator
          uv run pytest tests/ -v --tb=short \
            --cov=src/cafe_order_aggregator \
            --cov-report=xml:../../coverage-aggregator.xml \
            --cov-report=term-missing

      - name: Generate coverage summary
        run: |
          # Generate a simple combined summary
          echo "## Coverage Summary" > coverage-summary.md
          echo "" >> coverage-summary.md
          echo "| Package | Coverage |" >> coverage-summary.md
          echo "|---------|----------|" >> coverage-summary.md

          # Extract coverage percentages from XML files
          for pkg in shared api aggregator; do
            if [ -f "coverage-${pkg}.xml" ]; then
              # Extract line-rate from coverage XML
              rate=$(grep -o 'line-rate="[0-9.]*"' "coverage-${pkg}.xml" | head -1 | grep -o '[0-9.]*')
              if [ -n "$rate" ]; then
                pct=$(echo "$rate * 100" | bc -l | xargs printf "%.1f")
                echo "| ${pkg} | ${pct}% |" >> coverage-summary.md
              fi
            fi
          done

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage-*.xml
            coverage-summary.md

      - name: Add coverage comment to PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE_DATA_BRANCH: coverage-data
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 70
          ANNOTATE_MISSING_LINES: true
          ANNOTATION_TYPE: warning
        continue-on-error: true

      - name: Post coverage summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage summary
            let summary = '';
            try {
              summary = fs.readFileSync('coverage-summary.md', 'utf8');
            } catch (e) {
              summary = '## Coverage Summary\n\nCoverage data not available.';
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Coverage Summary')
            );

            const body = `${summary}

            ---
            *Updated for commit ${context.sha.substring(0, 7)}*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  unit-tests-frontend:
    name: Unit Tests (Frontend)
    runs-on: ubuntu-latest
    needs: lint-frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm test -- --run

  unit-tests-flink:
    name: Unit Tests (Flink)
    runs-on: ubuntu-latest
    needs: lint-flink
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Run tests with coverage
        run: |
          cd flink/coffee-rt-flink
          mvn clean verify -B

      - name: Generate coverage report
        run: |
          cd flink/coffee-rt-flink
          if [ -f target/site/jacoco/jacoco.xml ]; then
            # Extract coverage from JaCoCo XML
            covered=$(grep -o 'INSTRUCTION[^/]*' target/site/jacoco/jacoco.xml | grep -oP 'covered="\K[0-9]+' | head -1)
            missed=$(grep -o 'INSTRUCTION[^/]*' target/site/jacoco/jacoco.xml | grep -oP 'missed="\K[0-9]+' | head -1)
            if [ -n "$covered" ] && [ -n "$missed" ]; then
              total=$((covered + missed))
              if [ $total -gt 0 ]; then
                pct=$(awk "BEGIN {printf \"%.1f\", $covered/$total*100}")
                echo "Flink coverage: ${pct}%"
              fi
            fi
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-flink
          path: flink/coffee-rt-flink/target/site/jacoco/

  build-and-push:
    name: Build & Push ${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: [changes, unit-tests-backend, unit-tests-frontend, unit-tests-flink]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.changes.outputs.has_changes == 'true'
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.changes.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }} --output none

      - name: Set short SHA
        id: sha
        run: echo "short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/coffee-rt/${{ matrix.name }}:${{ steps.sha.outputs.short }}
            ${{ secrets.ACR_LOGIN_SERVER }}/coffee-rt/${{ matrix.name }}:latest
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}

  push-helm-chart:
    name: Package & Push Helm Chart
    runs-on: ubuntu-latest
    needs: [changes, unit-tests-backend, unit-tests-frontend, unit-tests-flink]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.changes.outputs.helm == 'true'
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.12.0

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }} --output none

      - name: Package Helm chart
        run: |
          cd helm/coffee-rt
          helm dependency update --skip-refresh 2>/dev/null || helm dependency update
          helm package .

      - name: Push Helm chart to ACR
        run: |
          cd helm/coffee-rt
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          helm push coffee-rt-${CHART_VERSION}.tgz oci://${{ secrets.ACR_LOGIN_SERVER }}/helm
